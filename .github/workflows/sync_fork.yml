name: Upstream Sync (Codex)

permissions:
  contents: write
  pull-requests: write

on:
  # schedule:
  #   - cron: "0 14 * * *" # 已改为仅手动触发
  workflow_dispatch:

jobs:
  sync_with_upstream:
    name: Sync with Upstream
    runs-on: ubuntu-latest
    if: ${{ github.event.repository.fork }}

    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 设置 Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: 写入 Codex 配置
        run: |
          mkdir -p ~/.codex
          cat > ~/.codex/config.toml <<'EOF'
          model_provider = "crs"
          model = "gpt-5.2-codex"

          [model_providers.crs]
          name = "crs"
          base_url = "https://capi.quan2go.com/openai"
          wire_api = "responses"
          requires_openai_auth = true

          [features]
          remote_models = false
          EOF

      - name: 配置 Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: 添加上游并获取
        run: |
          git remote add upstream https://github.com/huangxd-/danmu_api.git || true
          git fetch upstream
          git fetch origin

      - name: 检查是否有上游更新
        id: check
        run: |
          count=$(git rev-list --count origin/main..upstream/main)
          echo "ahead=$count" >> "$GITHUB_OUTPUT"

      - name: 无更新直接结束
        if: ${{ steps.check.outputs.ahead == '0' }}
        run: echo "无上游更新"

      - name: 创建同步分支并合并上游
        if: ${{ steps.check.outputs.ahead != '0' }}
        id: merge
        run: |
          branch="sync-upstream-$(date +%Y%m%d)"
          echo "branch=$branch" >> "$GITHUB_OUTPUT"
          git checkout -B "$branch" origin/main
          git merge --no-ff --no-edit upstream/main || true

      - name: 解决冲突（如有）
        if: ${{ steps.check.outputs.ahead != '0' }}
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_API_BASE: ${{ secrets.OPENAI_API_BASE }}
        run: |
          if git diff --name-only --diff-filter=U | grep -q .; then
            npm install -g @openai/codex
            codex exec "请在本仓库解决当前 Git 合并冲突，尽量保留本仓库的自定义修改，同时对齐上游 main。解决后确保没有未合并文件，不要运行测试。"
          fi
          if git diff --name-only --diff-filter=U | grep -q .; then
            echo "仍有未解决的冲突"
            exit 1
          fi
          if ! git diff --cached --quiet || ! git diff --quiet; then
            git add -A
            git commit -m "同步上游变更"
          fi

      - name: 创建 PR
        if: ${{ steps.check.outputs.ahead != '0' }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.merge.outputs.branch }}
          base: main
          title: "同步上游更新（自动）"
          body: |
            触发方式：手动触发
            说明：已自动合并上游变更并尝试解决冲突
